# Persistent Storage - Visual Architecture\n\n## System Overview\n\n```\n╔════════════════════════════════════════════════════════════════════════════╗\n║                    CYBERSEC ARENA - PERSISTENT STORAGE                    ║\n║                         (Hybrid Dual-Storage System)                       ║\n╚════════════════════════════════════════════════════════════════════════════╝\n\n                              React App\n                          (User Interactions)\n                                  │\n                                  │\n                  ┌───────────────▼───────────────┐\n                  │  ProgressProvider (Context)   │\n                  │  • Manages state              │\n                  │  • Detects changes            │\n                  │  • Triggers saves (100ms)     │\n                  └───────────────┬───────────────┘\n                                  │\n                          ┌─────────▼─────────┐\n                          │ Auto-Save Trigger │\n                          │ (100ms debounce)  │\n                          └────────┬──────────┘\n                                   │\n                    ┌──────────────┼──────────────┐\n                    │                             │\n                    ▼                             ▼\n          ┌─────────────────┐        ┌──────────────────────┐\n          │   localStorage  │        │ SupabaseStorageServ  │\n          │  (Always Saved) │        │   (Hybrid Service)   │\n          ├─────────────────┤        ├──────────────────────┤\n          │ • Instant save  │        │ 1. Save to localStorage\n          │ • Works offline │        │ 2. If auth: Save to DB\n          │ • ~5KB per user │        │ 3. Cross-device sync │\n          └────────┬────────┘        └──────────┬───────────┘\n                   │                            │\n                   └──────────────┬─────────────┘\n                                  │\n                          ┌───────▼────────┐\n                          │ Progress Data  │\n                          │ Persisted in   │\n                          │ TWO places ✅  │\n                          └────────────────┘\n                                  │\n                    ┌─────────────┴─────────────┐\n                    │                           │\n                    ▼                           ▼\n         ┌─────────────────────┐   ┌──────────────────────┐\n         │ Browser Storage     │   │ Supabase Database    │\n         │ localStorage        │   │ user_progress table  │\n         ├─────────────────────┤   ├──────────────────────┤\n         │ • ctf_solved_ids    │   │ • ctf_solved_ids     │\n         │ • phish_solved_ids  │   │ • phish_solved_ids   │\n         │ • code_solved_ids   │   │ • code_solved_ids    │\n         │ • quiz_answered     │   │ • quiz_answered      │\n         │ • quiz_correct      │   │ • quiz_correct       │\n         │ • quiz_difficulty   │   │ • quiz_difficulty    │\n         │ • firewall_bestScore│   │ • firewall_bestScore │\n         │ • badges            │   │ • badges             │\n         │                     │   │                      │\n         │ Persistent even     │   │ Synced to all        │\n         │ after logout ✅     │   │ devices ✅           │\n         └─────────────────────┘   └──────────────────────┘\n```\n\n## Data Flow - Save Operation\n\n```\nTIMELINE: User Solves Challenge #5\n\n  ↓\n  ├─ t=0ms        User clicks \"Solve Challenge\"\n  │\n  ├─ t=1ms        markCTFSolved('5') called\n  │\n  ├─ t=2ms        setState triggered\n  │               State: { ctf: { solvedIds: [..., 5] } }\n  │\n  ├─ t=10ms       useEffect detects change\n  │               Debounce timer started (wait 100ms)\n  │\n  ├─ t=100ms      Debounce timeout fires\n  │               storageService.save(state) called\n  │               │\n  │               ├─ STEP 1 (Immediate)\n  │               │  localStorage.setItem('cybersec_arena_progress_v1', {...})\n  │               │  ✅ SUCCESS: Data in browser storage\n  │               │\n  │               └─ STEP 2 (Best Effort)\n  │                  Check: isUserAuthenticated()?\n  │                  ├─ YES → Save to Supabase\n  │                  │        ✅ SUCCESS: Data synced to database\n  │                  │\n  │                  └─ NO → Skip Supabase\n  │                         ✅ OK: localStorage was saved anyway\n  │\n  └─ RESULT: Data persisted to localStorage GUARANTEED\n            Data persisted to Supabase if logged in ✅\n```\n\n## Data Flow - Load Operation\n\n```\nTIMELINE: User Refreshes Page (F5)\n\n  ↓\n  ├─ t=0ms        Page refreshes\n  │\n  ├─ t=50ms       ProgressProvider mounts\n  │\n  ├─ t=51ms       useEffect called\n  │               storageService.load() called\n  │               │\n  │               ├─ STEP 1 (Instant)\n  │               │  localStorage.getItem('cybersec_arena_progress_v1')\n  │               │  ✅ SUCCESS: Get local data in <5ms\n  │               │  Result: { ctf: { solvedIds: [..., 5] }, ... }\n  │               │\n  │               ├─ UI renders immediately with local data ✅\n  │               │\n  │               └─ STEP 2 (Background)\n  │                  Check: isUserAuthenticated()?\n  │                  ├─ YES → Load from Supabase (~500ms)\n  │                  │        ✅ SUCCESS: Fresh server data\n  │                  │        └─ Sync back to localStorage\n  │                  │           Keep both in sync ✅\n  │                  │\n  │                  └─ NO → Skip Supabase\n  │                         ✅ Use localStorage data\n  │\n  └─ RESULT: User sees progress in <5ms (instant)\n            Background sync ensures freshness\n            Both storage locations in sync ✅\n```\n\n## Scenario: User Logs Out and Continues Playing\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│ TIMELINE: Solve → Logout → Solve Again → Refresh           │\n└─────────────────────────────────────────────────────────────┘\n\n  1:00 PM - LOGGED IN\n  ├─ Solve CTF Challenge #1\n  ├─ Save: localStorage ✅ + Supabase ✅\n  └─ Result: { ctf: { solvedIds: [1] } }\n\n  1:05 PM - LOGOUT\n  ├─ User: Profile → Danger Zone → Logout\n  ├─ Session cleared\n  ├─ localStorage: [1] still there ✅\n  └─ Supabase: [1] still there ✅\n\n  1:10 PM - LOGGED OUT, CONTINUE PLAYING\n  ├─ Solve CTF Challenge #2\n  ├─ Save attempt:\n  │  ├─ localStorage ✅ SUCCESS: [1, 2]\n  │  └─ Supabase ❌ SKIPPED (no auth)\n  ├─ Progress: {ctf: { solvedIds: [1, 2] }}\n  └─ IMPORTANT: #2 is in localStorage, not Supabase (yet)\n\n  1:15 PM - REFRESH (still logged out)\n  ├─ Load: localStorage ✅ [1, 2]\n  ├─ Supabase: Skipped (no auth)\n  └─ User sees BOTH challenges! ✅\n\n  1:20 PM - LOGIN AGAIN\n  ├─ Load: localStorage [1, 2] ✅\n  ├─ Load: Supabase (now auth) [1]\n  ├─ Sync: Challenge #2 uploaded to Supabase\n  └─ ALL PROGRESS SAVED! ✅✅\n\n  GUARANTEE: No progress lost, even during logout!\n```\n\n## Error Handling Flow\n\n```\n┌─────────────────────────────────────────────────┐\n│ What Happens If Something Fails?                │\n└─────────────────────────────────────────────────┘\n\nSCENARIO 1: localStorage Fails\n├─ Catch error at save()\n├─ Throw error (this is critical)\n├─ Console shows error: \"Failed to save to localStorage\"\n├─ User sees error\n└─ Impact: Data not saved (critical failure)\n   → Likely browser issue (privacy mode, full storage)\n   → Solution: Use normal mode or clear cache\n\nSCENARIO 2: Supabase Save Fails (User Logged In)\n├─ localStorage ✅ SUCCESS\n├─ Supabase ❌ FAILED\n├─ Catch error, log it\n├─ DON'T throw error\n├─ Console shows: \"Failed to save to Supabase (but localStorage was saved)\"\n├─ User doesn't notice\n└─ Impact: Data in localStorage only (temporary)\n   → Will sync next time Supabase works\n   → User can continue playing\n\nSCENARIO 3: Supabase Load Fails (After Logout → Login)\n├─ localStorage ✅ AVAILABLE\n├─ Supabase ❌ FAILED\n├─ Catch error, log it\n├─ DON'T throw error\n├─ Return localStorage data\n├─ UI renders with local data\n└─ Impact: User sees progress, app fully functional\n   → Will retry Supabase on next load\n\nSCENARIO 4: Both Fail (Critical)\n├─ localStorage ❌ FAILED\n├─ Throw error\n├─ Console shows critical error\n├─ Impact: Severe system failure\n└─ Solution: Browser compatibility issue\n   → Try different browser\n   → Clear browser cache\n   → Enable localStorage\n```\n\n## Storage Priority Matrix\n\n```\n┌────────────────────────────────────────────────────────────┐\n│ Data Load Priority (What Gets Used?)                       │\n├────────────────────────────────────────────────────────────┤\n│                                                            │\n│ STATE      │ localStorage │ Supabase DB │ RESULT          │\n│ ───────────┼──────────────┼─────────────┼─────────────    │\n│ User Login │ Empty        │ Has Data    │ Load Supabase   │\n│            │              │             │ Sync to Local   │\n│            │              │             │ ✅ Fresh data   │\n│ ───────────┼──────────────┼─────────────┼─────────────    │\n│ Refresh    │ Has Data     │ Has Data    │ Load both       │\n│ (Logged in)│              │             │ Use Supabase    │\n│            │              │             │ Sync to Local   │\n│            │              │             │ ✅ Fresh data   │\n│ ───────────┼──────────────┼─────────────┼─────────────    │\n│ Refresh    │ Has Data     │ Can't read  │ Load Local      │\n│ (Logged out│              │ (no auth)   │ ✅ Works fine   │\n│ ───────────┼──────────────┼─────────────┼─────────────    │\n│ New Device │ Empty        │ Has Data    │ Load Supabase   │\n│ (Login)    │              │             │ Sync to Local   │\n│            │              │             │ ✅ Cross-device │\n│ ───────────┼──────────────┼─────────────┼─────────────    │\n│ Offline    │ Has Data     │ Unreachable │ Load Local      │\n│            │              │             │ ✅ Works fine   │\n│ ───────────┼──────────────┼─────────────┼─────────────    │\n│                                                            │\n│ GUARANTEE: Data always available from at least one source │\n└────────────────────────────────────────────────────────────┘\n```\n\n## Architecture Dependencies\n\n```\n┌─────────────────────────────────────────────┐\n│ src/lib/progress.tsx                        │\n│ (ProgressProvider Context)                  │\n├─────────────────────────────────────────────┤\n│ ├─ useState(defaultProgress)               │\n│ ├─ useEffect (load on mount)               │\n│ ├─ useEffect (save on change)              │\n│ └─ useMemo (api methods)                   │\n└────────────┬────────────────────────────────┘\n             │\n      ┌──────▼──────────┐\n      │ IProgressStorage│ (Interface)\n      └──────┬──────────┘\n             │\n    ┌────────┴────────┐\n    │                 │\n    ▼                 ▼\n┌──────────────┐ ┌─────────────────────┐\n│ LocalStorage │ │ SupabaseStorage     │\n│ Service      │ │ Service (Hybrid)    │\n├──────────────┤ ├─────────────────────┤\n│ • load()     │ │ • load()            │\n│ • save()     │ │ • save()            │\n│ • clear()    │ │ • clear()           │\n└──────────────┘ │                     │\n                 │ Uses:              │\n                 │ • LocalStorageServ │\n                 │ • Supabase Client  │\n                 └─────────────────────┘\n```\n\n## Storage Size Comparison\n\n```\n┌──────────────────────────────────────────────────────┐\n│ How Much Space Does Progress Take?                  │\n├──────────────────────────────────────────────────────┤\n│                                                      │\n│ Typical User Progress Data:                          │\n│ ├─ CTF solved IDs: 5-20 challenges        [1 KB]    │\n│ ├─ Phish solved IDs: 2-5 attempts        [0.5 KB]  │\n│ ├─ Code solved IDs: 3-10 solutions       [0.5 KB]  │\n│ ├─ Quiz data: 100 answered, 80 correct   [0.5 KB]  │\n│ ├─ Firewall best score: number           [0.1 KB]  │\n│ └─ Badges: 5-10 earned                   [0.5 KB]  │\n│                                                      │\n│ ┌─ TOTAL: ~3-5 KB per user                          │\n│                                                      │\n│ Browser Limits:                                      │\n│ ├─ Chrome:  10 MB   (2000x our size)               │\n│ ├─ Firefox: 10 MB   (2000x our size)               │\n│ ├─ Safari:  5 MB    (1000x our size)               │\n│ ├─ Edge:    10 MB   (2000x our size)               │\n│ └─ IE11:    10 MB   (2000x our size)               │\n│                                                      │\n│ ✅ NO STORAGE CONCERNS - Plenty of space available  │\n│                                                      │\n└──────────────────────────────────────────────────────┘\n```\n\n## Data Persistence Timeline\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│ PERSISTENCE TIMELINE - Single User Session                     │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│ DAY 1                                                          │\n│ 9:00 AM  │ Login             localStorage: [empty]  │         │\n│          │ Solve CTF #1      localStorage: [1]      │         │\n│          │                   Supabase: [1]          │         │\n│                                                                 │\n│ 1:00 PM  │ Refresh page      localStorage: [1] ✅              │\n│          │ (instant)         Supabase: [1] ✅                  │\n│                                                                 │\n│ 5:00 PM  │ Logout            localStorage: [1] ✅              │\n│          │                   Supabase: [1] ✅                  │\n│                                                                 │\n│ 7:00 PM  │ Solve CTF #2      localStorage: [1,2] ✅           │\n│          │ (offline)         Supabase: [1] (no sync)          │\n│                                                                 │\n│ 8:00 PM  │ Refresh page      localStorage: [1,2] ✅           │\n│          │ (still offline)   Supabase: [1] (unreachable)      │\n│                                                                 │\n│ DAY 2                                                          │\n│ 9:00 AM  │ Login             localStorage: [1,2] → sync       │\n│          │                   Supabase: [1,2] ✅ (synced!)      │\n│                                                                 │\n│ 12:00 PM │ On Device B       localStorage: [empty]            │\n│          │ Login             Load from Supabase: [1,2]         │\n│          │                   localStorage: [1,2] ✅            │\n│                                                                 │\n│ GUARANTEE: Progress ALWAYS visible and synced! ✅              │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n## System Health Check\n\n```\n┌──────────────────────────────────────────────────────┐\n│ How to Verify Persistent Storage is Working          │\n├──────────────────────────────────────────────────────┤\n│                                                      │\n│ ✅ PASS Indicators:                                  │\n│ ├─ localStorage has 'cybersec_arena_progress_v1'   │\n│ ├─ Data persists after F5 refresh                  │\n│ ├─ Data persists after logout                      │\n│ ├─ Console has no storage errors                   │\n│ ├─ Supabase user_progress table has your data      │\n│ ├─ App works offline                               │\n│ └─ Progress syncs across devices                   │\n│                                                      │\n│ ⚠️ WARNING Indicators:                              │\n│ ├─ localStorage empty after solving               │\n│ ├─ Console shows \"Failed to save to localStorage\" │\n│ ├─ Progress lost after logout                      │\n│ ├─ Supabase data not updating                      │\n│ └─ App shows errors on refresh                     │\n│                                                      │\n│ ❌ ERROR Indicators:                                │\n│ ├─ Critical storage failure message                │\n│ ├─ Both localStorage and Supabase fail             │\n│ ├─ Progress never saved anywhere                   │\n│ ├─ Data loss on refresh                            │\n│ └─ App won't load progress                         │\n│                                                      │\n└──────────────────────────────────────────────────────┘\n```\n\n## Summary\n\n```\n╔════════════════════════════════════════════════════════════╗\n║       PERSISTENT STORAGE - GUARANTEED FOREVER              ║\n╠════════════════════════════════════════════════════════════╣\n║                                                            ║\n║  ✅ Progress saved to localStorage immediately            ║\n║  ✅ Progress synced to Supabase when authenticated         ║\n║  ✅ Works offline with localStorage                       ║\n║  ✅ Works after logout with localStorage                  ║\n║  ✅ Works after refresh with localStorage                 ║\n║  ✅ Cross-device sync via Supabase                        ║\n║  ✅ Zero data loss on logout                             ║\n║  ✅ Zero data loss on browser crash                       ║\n║  ✅ Zero data loss on network failure                     ║\n║                                                            ║\n║  RESULT: ALL PROGRESS IS ALWAYS PERSISTED                 ║\n║                                                            ║\n╚════════════════════════════════════════════════════════════╝\n```\n"